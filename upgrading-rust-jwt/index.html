<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <meta property="og:type" content="website" />
      <meta property="og:url" content="https:&#x2F;&#x2F;blog.orhun.dev"/>
      <meta property="og:title" content="Orhun&#x27;s Blog" />
      <meta property="og:description" content="FOSS ‚Ä¢ Linux ‚Ä¢ Programming"/>
      <meta property="og:image" content="https:&#x2F;&#x2F;blog.orhun.dev/crow.png" />

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
      <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
      <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
      <link rel="manifest" href="/favicon/site.webmanifest">

      <script async defer data-website-id="56ca5ca7-ba9f-416e-8bee-a132c155d56b" src="https://umami.orhun.dev/umami.js"></script>

      <title>Orhun&#x27;s Blog</title>

      
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.orhun.dev/rss.xml">
      

      
          <link rel="stylesheet" href="https://blog.orhun.dev/site.css">
      

      
      
    </head>

    <body class="hack dark main container">
        
    
        
                
                    <header>
                        <nav itemscope itemtype="http://schema.org/SiteNavigationElement">
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;blog.orhun.dev">
                                <span itemprop="name">Home</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;blog.orhun.dev&#x2F;categories">
                                <span itemprop="name">Categories</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;github.com&#x2F;orhun&#x2F;personal-blog">
                                <span itemprop="name">Source</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;blog.orhun.dev&#x2F;rss.xml">
                                <span itemprop="name">RSS</span></a>
                        
                            <a itemprop="url"
                               class=""
                               href="https:&#x2F;&#x2F;orhun.dev">
                                <span itemprop="name">About</span></a>
                        
                        </nav>
                    </header>
                
            
    

<article itemscope itemtype="http://schema.org/BlogPosting">
    <header>
        <h1 itemprop="headline">How hard upgrading a Rust JWT library could be?</h1>
        <span class="muted">
    <svg style="margin-bottom:-3px" class="i-clock" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <circle cx="16" cy="16" r="14"/>
        <path d="M16 8 L16 16 20 20"/>
    </svg>
    <span>13 minute read</span>
    <svg style="margin-bottom: -3px" class="i-edit" viewBox="0 0 32 32"
         width="16" height="16" fill="none" stroke="currentcolor"
         stroke-linecap="round" stroke-linejoin="round" stroke-width="6.25%">
        <path d="M30 7 L25 2 5 22 3 29 10 27 Z M21 6 L26 11 Z M5 22 L10 27 Z"/>
    </svg>

    Published: 2022-04-22
</span>
    </header>
    <div itemprop="articleBody">
      <p>Recently one of my clients requested me to maintain their Rust project. It is a web server that is built with <a href="https://rocket.rs/">Rocket</a> + <a href="http://diesel.rs/">Diesel</a> and running stable for a couple of years now. Like any other Rust developer would do, the first thing that I checked was the outdated dependencies via <code>cargo-outdated</code>. The result was close to what I expected: most of the dependencies were out-of-date. However, among all those crates, <a href="https://github.com/mikkyang/rust-jwt">rust-jwt</a> caught my eye. It was 12 minor versions behind!</p>
<span id="continue-reading"></span><pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">Name                        Project  Compat  Latest   Kind    Platform
</span><span style="color:#cccccc;">----                        -------  ------  ------   ----    --------
</span><span style="color:#cccccc;">jwt                         0.4.0    ---     0.16.0   Normal  ---
</span></code></pre>
<p>Although this doesn't seem like a big problem, since it is not a major version or anything, I took this lightly and started working on updating the other dependencies. It is the JWT that everyone knows and loves after all, how hard updating this dependency would be?</p>
<p>Well, it turns out, it was pretty hard after in my case.</p>
<p>The version that the project used at the time was <code>0.4.0</code>. When I checked the changelog (release notes), there wasn't even an entry about it! Even worse, this version is not tagged on GitHub. The oldest version on GitHub was <code>0.5.0</code> and the release notes are the following:</p>
<blockquote>
<h3 id="update-very-outdated-dependencies">Update (very outdated) dependencies</h3>
<p>The only user facing changes are much needed updates to the crypto dependencies, courtesy of #10.</p>
<p>Types from the previous crate, <code>rust-crypto</code> are replaced with types from various crates from <a href="https://github.com/RustCrypto">https://github.com/RustCrypto</a>.</p>
</blockquote>
<p>Although this is a good improvement for the library itself, it surely didn't look too good for me. I have spent some time deciphering what these release notes mean and it eventually boils down to <a href="https://github.com/DaGenix/rust-crypto">rust-crypto</a> crate being unmaintained since 2016.</p>
<ul>
<li><a href="https://rustsec.org/advisories/RUSTSEC-2016-0005.html">RUSTSEC-2016-0005</a>: rust-crypto is unmaintained; switch to a modern alternative</li>
</ul>
<p>So the maintainer of rust-jwt made the most expected thing by moving away from <code>rust-crypto</code> and migrating the cryptography-related operations to be handled by the actively maintained <a href="https://github.com/RustCrypto">RustCrypto</a> project. I was sure I will benefit from this change in the security and performance aspect. </p>
<p>One thing to note here, was that really a &quot;minor&quot; change in rust-jwt? Can I just bump the dependency and call it a day?</p>
<p>Well, I don't know. I thought to myself &quot;Hey let me bump it to the latest version, it's all minor changes anyways&quot;. That's why I updated it to <code>0.16.0</code> and took a look at the previous changelog entries before attempting to compile the project.</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">0.6.0: New Token API
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">- Move all of the previous structs to the legacy module
</span><span style="color:#cccccc;">- Introduce more idiomatic Header, Claims, and Token types
</span><span style="color:#cccccc;">- Support more algorithms with optional OpenSSL support
</span><span style="color:#cccccc;">- Convenience methods to just sign and verify claims
</span></code></pre>
<p>So it seemed like I will be dealing with 2 issues:</p>
<ol>
<li>Side effects of &quot;rust-crypto -&gt; RustCrypto&quot;</li>
<li>New API</li>
</ol>
<h3 id="use-case">Use case</h3>
<p>To demonstrate my use case of this library, I wrote this oversimplified <a href="https://github.com/fornwall/rust-script">Rust script</a>:</p>
<pre data-lang="rs" style="background-color:#191919;color:#ffffff;" class="language-rs "><code class="language-rs" data-lang="rs"><span>#!/</span><span style="color:#cccccc;">usr</span><span>/</span><span style="color:#cccccc;">bin</span><span>/</span><span style="color:#cccccc;">env rust</span><span>-</span><span style="color:#cccccc;">script
</span><span style="background-color:#171717;color:#616161;">//! ```cargo
</span><span style="background-color:#171717;color:#616161;">//! [dependencies]
</span><span style="background-color:#171717;color:#616161;">//! jwt = &quot;0.4.0&quot;
</span><span style="background-color:#171717;color:#616161;">//! rust-crypto = &quot;0.2&quot;
</span><span style="background-color:#171717;color:#616161;">//! ```
</span><span style="color:#cccccc;">
</span><span>use </span><span style="color:#cccccc;">crypto::sha2::Sha256;
</span><span>use </span><span style="color:#cccccc;">jwt::{Header, Registered, Token};
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">const </span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">: </span><span>&amp;</span><span style="color:#80d500;">str </span><span>= </span><span style="color:#ffd700;">&quot;420&quot;</span><span style="color:#cccccc;">;
</span><span style="color:#80d500;">const </span><span style="color:#66ccff;">SECRET_KEY</span><span style="color:#cccccc;">: </span><span>&amp;</span><span style="color:#80d500;">str </span><span>= </span><span style="color:#ffd700;">&quot;verysecretkey&quot;</span><span style="color:#cccccc;">;
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">fn </span><span>main</span><span style="color:#cccccc;">() {
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> claims </span><span>=</span><span style="color:#cccccc;"> Registered {
</span><span style="color:#cccccc;">        sub: </span><span style="color:#8aa6c1;">Some</span><span style="color:#cccccc;">(</span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">to_string</span><span style="color:#cccccc;">()),
</span><span style="color:#cccccc;">        </span><span>..</span><span style="color:#8aa6c1;">Default</span><span style="color:#cccccc;">::default()
</span><span style="color:#cccccc;">    };
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> header </span><span>= </span><span style="color:#cccccc;">Header::default();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> token </span><span>= </span><span style="color:#cccccc;">Token::new(header, claims)
</span><span style="color:#cccccc;">        .</span><span style="color:#8aa6c1;">signed</span><span style="color:#cccccc;">(</span><span style="color:#66ccff;">SECRET_KEY</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">as_bytes</span><span style="color:#cccccc;">(), Sha256::new())
</span><span style="color:#cccccc;">        .</span><span style="color:#8aa6c1;">unwrap</span><span style="color:#cccccc;">();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    println!(</span><span style="color:#ffd700;">&quot;</span><span style="color:#66ccff;">{token}</span><span style="color:#ffd700;">&quot;</span><span style="color:#cccccc;">);
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> token </span><span>= </span><span style="color:#cccccc;">Token::&lt;Header, Registered&gt;::parse(</span><span>&amp;</span><span style="color:#cccccc;">token).</span><span style="color:#8aa6c1;">unwrap</span><span style="color:#cccccc;">();
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">if</span><span style="color:#cccccc;"> token.</span><span style="color:#8aa6c1;">verify</span><span style="color:#cccccc;">(</span><span style="color:#66ccff;">SECRET_KEY</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">as_bytes</span><span style="color:#cccccc;">(), Sha256::new()) {
</span><span style="color:#cccccc;">        assert_eq!(</span><span style="color:#8aa6c1;">Some</span><span style="color:#cccccc;">(</span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">to_string</span><span style="color:#cccccc;">()), token.claims.sub);
</span><span style="color:#cccccc;">    } </span><span style="color:#80d500;">else </span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">        panic!(</span><span style="color:#ffd700;">&quot;Token is not valid&quot;</span><span style="color:#cccccc;">)
</span><span style="color:#cccccc;">    }
</span><span style="color:#cccccc;">}
</span></code></pre>
<p>After upgrading the dependencies, the script looks something like this:</p>
<pre data-lang="rs" style="background-color:#191919;color:#ffffff;" class="language-rs "><code class="language-rs" data-lang="rs"><span>#!/</span><span style="color:#cccccc;">usr</span><span>/</span><span style="color:#cccccc;">bin</span><span>/</span><span style="color:#cccccc;">env rust</span><span>-</span><span style="color:#cccccc;">script
</span><span style="background-color:#171717;color:#616161;">//! ```cargo
</span><span style="background-color:#171717;color:#616161;">//! [dependencies]
</span><span style="background-color:#171717;color:#616161;">//! hmac = &quot;0.12.1&quot;
</span><span style="background-color:#171717;color:#616161;">//! jwt = &quot;0.16.0&quot;
</span><span style="background-color:#171717;color:#616161;">//! sha2 = &quot;0.10.2&quot;
</span><span style="background-color:#171717;color:#616161;">//! ```
</span><span style="color:#cccccc;">
</span><span>use </span><span style="color:#cccccc;">hmac::{Hmac, Mac};
</span><span>use </span><span style="color:#cccccc;">jwt::claims::RegisteredClaims;
</span><span>use </span><span style="color:#cccccc;">jwt::{Header, SignWithKey, Token, VerifyWithKey};
</span><span>use </span><span style="color:#cccccc;">sha2::Sha256;
</span><span>use </span><span style="color:#cccccc;">std::collections::BTreeMap;
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">const </span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">: </span><span>&amp;</span><span style="color:#80d500;">str </span><span>= </span><span style="color:#ffd700;">&quot;420&quot;</span><span style="color:#cccccc;">;
</span><span style="color:#80d500;">const </span><span style="color:#66ccff;">SECRET_KEY</span><span style="color:#cccccc;">: </span><span>&amp;</span><span style="color:#80d500;">str </span><span>= </span><span style="color:#ffd700;">&quot;verysecretkey&quot;</span><span style="color:#cccccc;">;
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">fn </span><span>main</span><span style="color:#cccccc;">() {
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> secret_key </span><span>= </span><span style="color:#cccccc;">Hmac::&lt;Sha256&gt;::new_from_slice(</span><span style="color:#66ccff;">SECRET_KEY</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">as_bytes</span><span style="color:#cccccc;">()).</span><span style="color:#8aa6c1;">unwrap</span><span style="color:#cccccc;">();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> claims </span><span>=</span><span style="color:#cccccc;"> RegisteredClaims {
</span><span style="color:#cccccc;">        subject: </span><span style="color:#8aa6c1;">Some</span><span style="color:#cccccc;">(</span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">to_string</span><span style="color:#cccccc;">()),
</span><span style="color:#cccccc;">        </span><span>..</span><span style="color:#8aa6c1;">Default</span><span style="color:#cccccc;">::default()
</span><span style="color:#cccccc;">    };
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> header </span><span>= </span><span style="color:#cccccc;">Header::default();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> token </span><span>= </span><span style="color:#cccccc;">Token::new(header, claims)
</span><span style="color:#cccccc;">        .</span><span style="color:#8aa6c1;">sign_with_key</span><span style="color:#cccccc;">(</span><span>&amp;</span><span style="color:#cccccc;">secret_key)
</span><span style="color:#cccccc;">        .</span><span style="color:#8aa6c1;">unwrap</span><span style="color:#cccccc;">();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    println!(</span><span style="color:#ffd700;">&quot;</span><span style="color:#66ccff;">{}</span><span style="color:#ffd700;">&quot;</span><span style="color:#cccccc;">, token.</span><span style="color:#8aa6c1;">as_str</span><span style="color:#cccccc;">());
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">match </span><span style="color:#cccccc;">VerifyWithKey::&lt;Token&lt;Header, BTreeMap&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">, </span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">&gt;, </span><span>_</span><span style="color:#cccccc;">&gt;&gt;::verify_with_key(
</span><span style="color:#cccccc;">        token.</span><span style="color:#8aa6c1;">as_str</span><span style="color:#cccccc;">(),
</span><span style="color:#cccccc;">        </span><span>&amp;</span><span style="color:#cccccc;">secret_key,
</span><span style="color:#cccccc;">    ) {
</span><span style="color:#cccccc;">        </span><span style="color:#8aa6c1;">Ok</span><span style="color:#cccccc;">(token) </span><span>=&gt; </span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">            assert_eq!(</span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">to_string</span><span style="color:#cccccc;">(), token.</span><span style="color:#8aa6c1;">claims</span><span style="color:#cccccc;">()[</span><span style="color:#ffd700;">&quot;sub&quot;</span><span style="color:#cccccc;">]);
</span><span style="color:#cccccc;">        }
</span><span style="color:#cccccc;">        </span><span style="color:#8aa6c1;">Err</span><span style="color:#cccccc;">(e) </span><span>=&gt; </span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">            panic!(</span><span style="color:#ffd700;">&quot;Token is not valid: {}&quot;</span><span style="color:#cccccc;">, e)
</span><span style="color:#cccccc;">        }
</span><span style="color:#cccccc;">    }
</span><span style="color:#cccccc;">}
</span></code></pre>
<p>Let's check the output of both scripts:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ ./jwt-0.4.0.rs
</span><span style="color:#cccccc;">eyJ0eXAiOiJKV1QiLCJraWQiOm51bGwsImFsZyI6IkhTMjU2In0.eyJpc3MiOm51bGwsInN1YiI6IjQyMCIsImF1ZCI6bnVsbCwiZXhwIjpudWxsLCJuYmYiOm51bGwsImlhdCI6bnVsbCwianRpIjpudWxsfQ./sN8Ur+b+38g4X2yQsIuhs4Z1dWjPW+7SHSFgmYa4xM
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">$ ./jwt-0.16.0.rs
</span><span style="color:#cccccc;">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI0MjAifQ.wvPvTjXDF9tfOmB8ZjVh9Bosx5zw9M5SCpQ_NMI29OI
</span></code></pre>
<p>Hmm, they print different tokens and the second one is visibly shorter for some reason. This is probably due to the API changes in the library. </p>
<blockquote>
<p>So what? Just upgrade the dependencies, it works.</p>
</blockquote>
<p>Well, that's right. However, there is a bigger problem.</p>
<h3 id="architecture">Architecture</h3>
<p>In the current architecture, JWT tokens are stored on the user device and used for authentication. On top of that, there is a &quot;use without registration&quot; feature of the app which means users can take a look at the app and use some of the features without logging in but still they will have a JWT token associated in case they want to register later on.</p>
<p><img src="/jwt-server-client-architecture.png" alt="Architecture" /></p>
<p>At the end of the day, changing the JWT decoding logic in an incompatible way would make the tokens of those &quot;anonymous&quot; users invalid thus they will be logged out and lose their data. On the other hand, normal users will also be logged out but a new JWT token will be generated on login. Anonymous users cannot log in because... well, they are anonymous.</p>
<p>At this point, I realized I was dealing with a dependency that will eventually affect <strong>~100k</strong> users. Simply bumping rust-jwt will discard all the existing JWT tokens and make the application unusable for the majority of the users. Some time passed and I put more thought into this topic and we came up with a solution with the help of my colleague:</p>
<ol>
<li>Add an API endpoint for renewing the JWT token of a user.</li>
<li>Call this endpoint from the mobile application to renew the user token.</li>
<li>Hope that most of the users will update the app and have their tokens renewed.</li>
</ol>
<p>Although this sounds like a feasible solution, it requires an unnecessary amount of time and work. Plus I had different priorities at the time so I postponed it for later, thinking that I will eventually feel less lazy to implement and coordinate this.</p>
<p>Unsurprisingly, it didn't happen.</p>
<h3 id="inspection">Inspection</h3>
<p>I decided to debug this issue further and understand the root cause of this problem. Why would two different versions of the same library yield two completely different and incompatible tokens? There wasn't even a major change in the library!</p>
<p>Let's inspect the previously generated tokens with <a href="https://github.com/mike-engel/jwt-cli">jwt-cli</a>:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ ./jwt-0.4.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token header
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;typ&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;JWT&quot;</span><span style="color:#cccccc;">,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;alg&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;HS256&quot;
</span><span style="color:#cccccc;">}
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token claims
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;aud&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;exp&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;iat&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;iss&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;jti&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;nbf&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;sub&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;420&quot;
</span><span style="color:#cccccc;">}
</span></code></pre>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ ./jwt-0.16.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token header
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;alg&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;HS256&quot;
</span><span style="color:#cccccc;">}
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token claims
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;sub&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;420&quot;
</span><span style="color:#cccccc;">}
</span></code></pre>
<p>The newer version of rust-jwt strips the empty (null) fields from claims, that's why the generated token is different (and shorter than I expected). Also, <code>typ</code> field is missing from the header.</p>
<blockquote>
<p>You already know where this is going. I'm going to modify the rust-jwt library for my needs!</p>
</blockquote>
<p>Let's solve the missing header field problem first by explicitly specifying <code>typ</code> while defining the header:</p>
<pre data-lang="rs" style="background-color:#191919;color:#ffffff;" class="language-rs "><code class="language-rs" data-lang="rs"><span style="color:#80d500;">let</span><span style="color:#cccccc;"> header </span><span>=</span><span style="color:#cccccc;"> Header {
</span><span style="color:#cccccc;">    algorithm: jwt::AlgorithmType::Hs256,
</span><span style="color:#cccccc;">    type_: </span><span style="color:#8aa6c1;">Some</span><span style="color:#cccccc;">(jwt::header::HeaderType::JsonWebToken),
</span><span style="color:#cccccc;">    </span><span>..</span><span style="color:#8aa6c1;">Default</span><span style="color:#cccccc;">::default()
</span><span style="color:#cccccc;">};
</span></code></pre>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ ./jwt-0.16.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token header
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;typ&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;JWT&quot;</span><span style="color:#cccccc;">,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;alg&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;HS256&quot;
</span><span style="color:#cccccc;">}
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token claims
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;sub&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;420&quot;
</span><span style="color:#cccccc;">}
</span></code></pre>
<p>Nice! We have the correct header fields in the generated token. Also, why not update the <a href="https://doc.rust-lang.org/std/default/trait.Default.html">Default</a> implementation of <a href="https://github.com/mikkyang/rust-jwt/blob/a09172fcbf667db7a982c787ff709c6d6294ef18/src/header.rs#L32">Header</a> so that we can use it as it was before?</p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="background-color:#420e09;color:#f8f8f8;">-#[derive(Default, Debug, PartialEq, Serialize, Deserialize)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+#[derive(Debug, PartialEq, Serialize, Deserialize)]
</span><span style="color:#cccccc;"> pub struct Header {
</span><span style="color:#cccccc;">     #[serde(rename = &quot;typ&quot;)]
</span><span style="color:#cccccc;">     pub type_: Option&lt;HeaderType&gt;,
</span><span style="background-color:#0e2231;font-style:italic;color:#f8f8f8;">@@ -43,6 +43,17 @@ pub struct Header {
</span><span style="color:#cccccc;">     pub content_type: Option&lt;HeaderContentType&gt;,
</span><span style="color:#cccccc;"> }
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#253b22;color:#f8f8f8;">+impl Default for Header {
</span><span style="background-color:#253b22;color:#f8f8f8;">+    fn default() -&gt; Header {
</span><span style="background-color:#253b22;color:#f8f8f8;">+        Header {
</span><span style="background-color:#253b22;color:#f8f8f8;">+            type_: Some(HeaderType::JsonWebToken),
</span><span style="background-color:#253b22;color:#f8f8f8;">+            key_id: None,
</span><span style="background-color:#253b22;color:#f8f8f8;">+            algorithm: AlgorithmType::Hs256,
</span><span style="background-color:#253b22;color:#f8f8f8;">+            content_type: None,
</span><span style="background-color:#253b22;color:#f8f8f8;">+        }
</span><span style="background-color:#253b22;color:#f8f8f8;">+    }
</span><span style="background-color:#253b22;color:#f8f8f8;">+}
</span><span style="background-color:#253b22;color:#f8f8f8;">+
</span></code></pre>
<p><a href="https://github.com/orhun/rust-jwt/commit/a2433724a4ed4f1e028624968b6f0d4eb67c4734">https://github.com/orhun/rust-jwt/commit/a2433724a4ed4f1e028624968b6f0d4eb67c4734</a></p>
<p>Ta-da!</p>
<pre data-lang="rs" style="background-color:#191919;color:#ffffff;" class="language-rs "><code class="language-rs" data-lang="rs"><span style="color:#80d500;">let</span><span style="color:#cccccc;"> header </span><span>= </span><span style="color:#cccccc;">Header::default();
</span></code></pre>
<p>Next step, let's figure out why null fields do not exist in the token.</p>
<p>The answer is shrouded in the struct definition of <a href="https://github.com/mikkyang/rust-jwt/blob/a09172fcbf667db7a982c787ff709c6d6294ef18/src/claims.rs#L31"><code>RegisteredClaims</code></a>:</p>
<pre data-lang="rs" style="background-color:#191919;color:#ffffff;" class="language-rs "><code class="language-rs" data-lang="rs"><span style="color:#cccccc;">#[derive(Clone, Debug, Default, PartialEq, Serialize, Deserialize)]
</span><span style="color:#80d500;">pub struct </span><span style="color:#cccccc;">RegisteredClaims {
</span><span style="color:#cccccc;">    #[serde(rename </span><span>= </span><span style="color:#ffd700;">&quot;iss&quot;</span><span style="color:#cccccc;">, skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">issuer: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">&gt;,
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    #[serde(rename </span><span>= </span><span style="color:#ffd700;">&quot;sub&quot;</span><span style="color:#cccccc;">, skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">subject: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">&gt;,
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    #[serde(rename </span><span>= </span><span style="color:#ffd700;">&quot;aud&quot;</span><span style="color:#cccccc;">, skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">audience: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">&gt;,
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    #[serde(rename </span><span>= </span><span style="color:#ffd700;">&quot;exp&quot;</span><span style="color:#cccccc;">, skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">expiration: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;SecondsSinceEpoch&gt;,
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    #[serde(rename </span><span>= </span><span style="color:#ffd700;">&quot;nbf&quot;</span><span style="color:#cccccc;">, skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">not_before: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;SecondsSinceEpoch&gt;,
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    #[serde(rename </span><span>= </span><span style="color:#ffd700;">&quot;iat&quot;</span><span style="color:#cccccc;">, skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">issued_at: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;SecondsSinceEpoch&gt;,
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    #[serde(rename </span><span>= </span><span style="color:#ffd700;">&quot;jti&quot;</span><span style="color:#cccccc;">, skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">json_web_token_id: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">&gt;,
</span><span style="color:#cccccc;">}
</span></code></pre>
<p>Bingo! <a href="https://serde.rs/field-attrs.html#skip_serializing_if">skip_serializing_if</a> attribute in combination with &quot;Option::is_none&quot; causes <code>None</code> fields to be removed from the generated token. So let's just remove that attribute. </p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="color:#cccccc;"> #[derive(Clone, Debug, Default, PartialEq, Serialize, Deserialize)]
</span><span style="color:#cccccc;"> pub struct RegisteredClaims {
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;iss&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;iss&quot;)]
</span><span style="color:#cccccc;">     pub issuer: Option&lt;String&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;sub&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;sub&quot;)]
</span><span style="color:#cccccc;">     pub subject: Option&lt;String&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;aud&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;aud&quot;)]
</span><span style="color:#cccccc;">     pub audience: Option&lt;String&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;exp&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;exp&quot;)]
</span><span style="color:#cccccc;">     pub expiration: Option&lt;SecondsSinceEpoch&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;nbf&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;nbf&quot;)]
</span><span style="color:#cccccc;">     pub not_before: Option&lt;SecondsSinceEpoch&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;iat&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;iat&quot;)]
</span><span style="color:#cccccc;">     pub issued_at: Option&lt;SecondsSinceEpoch&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;jti&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;jti&quot;)]
</span><span style="color:#cccccc;">     pub json_web_token_id: Option&lt;String&gt;,
</span><span style="color:#cccccc;"> }
</span></code></pre>
<p><a href="https://github.com/orhun/rust-jwt/commit/4ef2ff4768a6485281e1bd451dee502bfc185d0d">https://github.com/orhun/rust-jwt/commit/4ef2ff4768a6485281e1bd451dee502bfc185d0d</a></p>
<p>That should be enough, right?</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ ./jwt-0.16.0.rs
</span><span style="color:#cccccc;">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOm51bGwsInN1YiI6IjQyMCIsImF1ZCI6bnVsbCwiZXhwIjpudWxsLCJuYmYiOm51bGwsImlhdCI6bnVsbCwianRpIjpudWxsfQ.mXy5xf4an2Bfv6mmhABh9-Yfmqit2AeXZWahCPgrvr0
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">thread </span><span style="color:#ffd700;">&#39;main&#39;</span><span style="color:#cccccc;"> panicked at </span><span style="color:#ffd700;">&#39;Token is not valid: invalid type: null, expected a string at line 1 column 11&#39;</span><span style="color:#cccccc;">, jwt-0.16.0.rs:45:13
</span><span style="color:#cccccc;">note: run with `RUST_BACKTRACE</span><span>=</span><span style="color:#ffd700;">1</span><span style="color:#cccccc;">` environment variable to display a backtrace
</span></code></pre>
<p>Uhm... verification failed. It is because we allowed <code>Option</code> types by removing the serde attribute so we should update the generic parameter from <code>String</code> to <code>Option&lt;String&gt;</code> in our expected claims data in the script:</p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="background-color:#420e09;color:#f8f8f8;">-    match VerifyWithKey::&lt;Token&lt;Header, BTreeMap&lt;String, String&gt;, _&gt;&gt;::verify_with_key(
</span><span style="background-color:#253b22;color:#f8f8f8;">+    match VerifyWithKey::&lt;Token&lt;Header, BTreeMap&lt;String, Option&lt;String&gt;&gt;, _&gt;&gt;::verify_with_key(
</span><span style="color:#cccccc;">         token.as_str(),
</span><span style="color:#cccccc;">         &amp;secret_key,
</span><span style="color:#cccccc;">     ) {
</span><span style="color:#cccccc;">         Ok(token) =&gt; {
</span><span style="background-color:#420e09;color:#f8f8f8;">-            assert_eq!(DATA.to_string(), token.claims()[&quot;sub&quot;]);
</span><span style="background-color:#253b22;color:#f8f8f8;">+            assert_eq!(Some(DATA.to_string()), token.claims()[&quot;sub&quot;]);
</span><span style="color:#cccccc;">         }
</span><span style="color:#cccccc;">         Err(e) =&gt; {
</span><span style="color:#cccccc;">             panic!(&quot;Token is not valid: {}&quot;, e)
</span></code></pre>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ ./jwt-0.16.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token header
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;typ&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;JWT&quot;</span><span style="color:#cccccc;">,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;alg&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;HS256&quot;
</span><span style="color:#cccccc;">}
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">Token claims
</span><span style="color:#cccccc;">------------
</span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;aud&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;exp&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;iat&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;iss&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;jti&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;nbf&quot;</span><span style="color:#cccccc;">: null,
</span><span style="color:#cccccc;">  </span><span style="color:#ffd700;">&quot;sub&quot;</span><span style="color:#cccccc;">: </span><span style="color:#ffd700;">&quot;420&quot;
</span><span style="color:#cccccc;">}
</span></code></pre>
<p>Good. We now have null fields in the claims. But do we have the same data in tokens generated by both scripts?</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ diff </span><span>&lt;</span><span style="color:#cccccc;">(./jwt-0.4.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -) </span><span>&lt;</span><span style="color:#cccccc;">(./jwt-0.16.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -) </span><span>&amp;&amp; </span><span style="color:#8aa6c1;">echo </span><span style="color:#ffd700;">&quot;decode result is the same&quot;
</span><span style="color:#cccccc;">decode result is the same
</span></code></pre>
<p>Yay! It is the expected output. Let's check the tokens too if they are the same:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ ./jwt-0.4.0.rs
</span><span style="color:#cccccc;">eyJ0eXAiOiJKV1QiLCJraWQiOm51bGwsImFsZyI6IkhTMjU2In0.eyJpc3MiOm51bGwsInN1YiI6IjQyMCIsImF1ZCI6bnVsbCwiZXhwIjpudWxsLCJuYmYiOm51bGwsImlhdCI6bnVsbCwianRpIjpudWxsfQ./sN8Ur+b+38g4X2yQsIuhs4Z1dWjPW+7SHSFgmYa4xM
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">$ ./jwt-0.16.0.rs
</span><span style="color:#cccccc;">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOm51bGwsInN1YiI6IjQyMCIsImF1ZCI6bnVsbCwiZXhwIjpudWxsLCJuYmYiOm51bGwsImlhdCI6bnVsbCwianRpIjpudWxsfQ.mXy5xf4an2Bfv6mmhABh9-Yfmqit2AeXZWahCPgrvr0
</span></code></pre>
<p>Uh-oh... Token data is exactly the same according to <code>jwt-cli</code> but tokens are different. What is going on?</p>
<blockquote>
<p>WE'VE BEEN BAMBOOZLED.</p>
</blockquote>
<p>It turns out <code>jwt-cli</code> was wrong /o\</p>
<p>It uses <a href="https://github.com/Keats/jsonwebtoken">jsonwebtoken</a> under the hood for decoding the tokens and this library has the same serde attribute:</p>
<pre data-lang="rs" style="background-color:#191919;color:#ffffff;" class="language-rs "><code class="language-rs" data-lang="rs"><span style="color:#cccccc;">#[derive(Debug, Clone, PartialEq, Serialize, Deserialize, Hash)]
</span><span style="color:#80d500;">pub struct </span><span style="color:#cccccc;">Header {
</span><span style="color:#cccccc;">    </span><span style="background-color:#171717;color:#616161;">/// The type of JWS: it can only be &quot;JWT&quot; here
</span><span style="color:#cccccc;">    </span><span style="background-color:#171717;color:#616161;">///
</span><span style="color:#cccccc;">    </span><span style="background-color:#171717;color:#616161;">/// Defined in [RFC7515#4.1.9](https://tools.ietf.org/html/rfc7515#section-4.1.9).
</span><span style="color:#cccccc;">    #[serde(skip_serializing_if </span><span>= </span><span style="color:#ffd700;">&quot;Option::is_none&quot;</span><span style="color:#cccccc;">)]
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">pub </span><span style="color:#cccccc;">typ: </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">&gt;,
</span><span style="color:#cccccc;">    </span><span style="background-color:#171717;color:#616161;">/// &lt;strip&gt;
</span></code></pre>
<p>See <a href="https://github.com/Keats/jsonwebtoken/blob/e869bff62fddb039ea20c60813549d30aa00e7f2/src/header.rs#L13">jsonwebtoken::Header</a></p>
<p>So that's why null fields are not shown in the output. ü§¶üèº‚Äç‚ôÇÔ∏è</p>
<p>Later on I used <a href="https://jwt.io/">jwt.io</a> to compare the data of the both tokens and it revealed the following result:</p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="color:#cccccc;"> {
</span><span style="background-color:#420e09;color:#f8f8f8;">-  &quot;alg&quot;: &quot;HS256&quot;,
</span><span style="background-color:#420e09;color:#f8f8f8;">-  &quot;typ&quot;: &quot;JWT&quot;
</span><span style="background-color:#253b22;color:#f8f8f8;">+  &quot;typ&quot;: &quot;JWT&quot;,
</span><span style="background-color:#253b22;color:#f8f8f8;">+  &quot;kid&quot;: null,
</span><span style="background-color:#253b22;color:#f8f8f8;">+  &quot;alg&quot;: &quot;HS256&quot;
</span><span style="color:#cccccc;"> }
</span></code></pre>
<p>So only <code>kid</code> is missing from the header? Alright, easy:</p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="color:#cccccc;"> pub struct Header {
</span><span style="color:#cccccc;">     #[serde(rename = &quot;alg&quot;)]
</span><span style="color:#cccccc;">     pub algorithm: AlgorithmType,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;kid&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;kid&quot;)]
</span><span style="color:#cccccc;">     pub key_id: Option&lt;String&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="color:#cccccc;">     #[serde(rename = &quot;typ&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span></code></pre>
<p><a href="https://github.com/orhun/rust-jwt/commit/b8c4b78d357fa20f54afc4c1ddcc0cb29479e1a4">https://github.com/orhun/rust-jwt/commit/b8c4b78d357fa20f54afc4c1ddcc0cb29479e1a4</a></p>
<p>How about now?</p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="color:#cccccc;"> {
</span><span style="background-color:#420e09;color:#f8f8f8;">-  &quot;alg&quot;: &quot;HS256&quot;,
</span><span style="background-color:#253b22;color:#f8f8f8;">+  &quot;typ&quot;: &quot;JWT&quot;,
</span><span style="color:#cccccc;">   &quot;kid&quot;: null,
</span><span style="background-color:#420e09;color:#f8f8f8;">-  &quot;typ&quot;: &quot;JWT&quot;
</span><span style="background-color:#253b22;color:#f8f8f8;">+  &quot;alg&quot;: &quot;HS256&quot;
</span><span style="color:#cccccc;"> }
</span></code></pre>
<p>Oooh, they need to be in the same order as well. Let's reorder the struct fields:</p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="color:#cccccc;"> pub struct Header {
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;alg&quot;)]
</span><span style="background-color:#420e09;color:#f8f8f8;">-    pub algorithm: AlgorithmType,
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;typ&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    pub type_: Option&lt;HeaderType&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="color:#cccccc;">     #[serde(rename = &quot;kid&quot;)]
</span><span style="color:#cccccc;">     pub key_id: Option&lt;String&gt;,
</span><span style="color:#cccccc;"> 
</span><span style="background-color:#420e09;color:#f8f8f8;">-    #[serde(rename = &quot;typ&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="background-color:#420e09;color:#f8f8f8;">-    pub type_: Option&lt;HeaderType&gt;,
</span><span style="background-color:#253b22;color:#f8f8f8;">+    #[serde(rename = &quot;alg&quot;)]
</span><span style="background-color:#253b22;color:#f8f8f8;">+    pub algorithm: AlgorithmType,
</span><span style="color:#cccccc;"> 
</span><span style="color:#cccccc;">     #[serde(rename = &quot;cty&quot;, skip_serializing_if = &quot;Option::is_none&quot;)]
</span><span style="color:#cccccc;">     pub content_type: Option&lt;HeaderContentType&gt;,
</span></code></pre>
<p><a href="https://github.com/orhun/rust-jwt/commit/c6d2fb9cc635ee0beafdeaebdac68c5d9e0d7c23">https://github.com/orhun/rust-jwt/commit/c6d2fb9cc635ee0beafdeaebdac68c5d9e0d7c23</a></p>
<p>That should be fine now. Please god!</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">$ diff </span><span>&lt;</span><span style="color:#cccccc;">(./jwt-0.4.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -) </span><span>&lt;</span><span style="color:#cccccc;">(./jwt-0.16.0.rs </span><span>| </span><span style="color:#cccccc;">jwt decode -)
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">$ diff </span><span>&lt;</span><span style="color:#cccccc;">(./jwt-0.4.0.rs) </span><span>&lt;</span><span style="color:#cccccc;">(./jwt-0.16.0.rs)
</span><span style="color:#cccccc;">1c1
</span><span>&lt;</span><span style="color:#cccccc;"> eyJ0eXAiOiJKV1QiLCJraWQiOm51bGwsImFsZyI6IkhTMjU2In0.eyJpc3MiOm51bGwsInN1YiI6IjQyMCIsImF1ZCI6bnVsbCwiZXhwIjpudWxsLCJuYmYiOm51bGwsImlhdCI6bnVsbCwianRpIjpudWxsfQ./sN8Ur+b+38g4X2yQsIuhs4Z1dWjPW+7SHSFgmYa4xM
</span><span style="color:#cccccc;">---
</span><span>&gt;</span><span style="color:#cccccc;"> eyJ0eXAiOiJKV1QiLCJraWQiOm51bGwsImFsZyI6IkhTMjU2In0.eyJpc3MiOm51bGwsInN1YiI6IjQyMCIsImF1ZCI6bnVsbCwiZXhwIjpudWxsLCJuYmYiOm51bGwsImlhdCI6bnVsbCwianRpIjpudWxsfQ._sN8Ur-b-38g4X2yQsIuhs4Z1dWjPW-7SHSFgmYa4xM
</span></code></pre>
<p>WHAT!? OH... WAIT... They look so similar. Only the signature part is slightly different:</p>
<pre data-lang="sh" style="background-color:#191919;color:#ffffff;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#cccccc;">/sN8Ur+b+38g4X2yQsIuhs4Z1dWjPW+7SHSFgmYa4xM
</span><span style="color:#cccccc;">_sN8Ur-b-38g4X2yQsIuhs4Z1dWjPW-7SHSFgmYa4xM
</span></code></pre>
<p>(<code>/</code> instead of <code>_</code> &amp; <code>+</code> instead of <code>-</code>)</p>
<p>Well, it turns out they are actually the same token. According to the warning on jwt.io, the difference is due to the first token not being encoded correctly:</p>
<blockquote>
<p>Warning: Looks like your JWT signature is not encoded correctly using base64url (<a href="https://tools.ietf.org/html/rfc4648#section-5">https://tools.ietf.org/html/rfc4648#section-5</a>).</p>
<p>Note that padding (&quot;=&quot;) must be omitted as per <a href="https://tools.ietf.org/html/rfc7515#section-2">https://tools.ietf.org/html/rfc7515#section-2</a></p>
</blockquote>
<p>Just to be safe, I decided to replace the invalid characters in the signature before verifying:</p>
<pre data-lang="diff" style="background-color:#191919;color:#ffffff;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="background-color:#420e09;color:#f8f8f8;">-        if key.verify(header_str, claims_str, signature_str)? {
</span><span style="background-color:#253b22;color:#f8f8f8;">+        let signature_str = signature_str.replace(&#39;+&#39;, &quot;-&quot;).replace(&#39;/&#39;, &quot;_&quot;);
</span><span style="background-color:#253b22;color:#f8f8f8;">+        if key.verify(header_str, claims_str, &amp;signature_str)? {
</span><span style="color:#cccccc;">             Ok(Token {
</span><span style="color:#cccccc;">                 header: self.header,
</span><span style="color:#cccccc;">                 claims: self.claims,
</span></code></pre>
<p><a href="https://github.com/orhun/rust-jwt/commit/3a47cae2b5d2a12a46548c07646305f1df0e1253">https://github.com/orhun/rust-jwt/commit/3a47cae2b5d2a12a46548c07646305f1df0e1253</a></p>
<p>And then I tested it with different tokens and had no issues, meaning that this -<em>slightly modified</em>- version of rust-jwt is used in production now! üéâ</p>
<details>
<summary>The final version of the script</summary>
<pre data-lang="rs" style="background-color:#191919;color:#ffffff;" class="language-rs "><code class="language-rs" data-lang="rs"><span>#!/</span><span style="color:#cccccc;">usr</span><span>/</span><span style="color:#cccccc;">bin</span><span>/</span><span style="color:#cccccc;">env rust</span><span>-</span><span style="color:#cccccc;">script
</span><span style="background-color:#171717;color:#616161;">//! ```cargo
</span><span style="background-color:#171717;color:#616161;">//! [dependencies]
</span><span style="background-color:#171717;color:#616161;">//! hmac = &quot;0.12.1&quot;
</span><span style="background-color:#171717;color:#616161;">//! jwt = { version=&quot;0.16.0&quot;, git=&quot;https://github.com/orhun/rust-jwt&quot;  }
</span><span style="background-color:#171717;color:#616161;">//! sha2 = &quot;0.10.2&quot;
</span><span style="background-color:#171717;color:#616161;">//! ```
</span><span style="color:#cccccc;">
</span><span>use </span><span style="color:#cccccc;">hmac::{Hmac, Mac};
</span><span>use </span><span style="color:#cccccc;">jwt::claims::RegisteredClaims;
</span><span>use </span><span style="color:#cccccc;">jwt::{Header, SignWithKey, Token, VerifyWithKey};
</span><span>use </span><span style="color:#cccccc;">sha2::Sha256;
</span><span>use </span><span style="color:#cccccc;">std::collections::BTreeMap;
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">const </span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">: </span><span>&amp;</span><span style="color:#80d500;">str </span><span>= </span><span style="color:#ffd700;">&quot;420&quot;</span><span style="color:#cccccc;">;
</span><span style="color:#80d500;">const </span><span style="color:#66ccff;">SECRET_KEY</span><span style="color:#cccccc;">: </span><span>&amp;</span><span style="color:#80d500;">str </span><span>= </span><span style="color:#ffd700;">&quot;verysecretkey&quot;</span><span style="color:#cccccc;">;
</span><span style="color:#cccccc;">
</span><span style="color:#80d500;">fn </span><span>main</span><span style="color:#cccccc;">() {
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> secret_key </span><span>= </span><span style="color:#cccccc;">Hmac::&lt;Sha256&gt;::new_from_slice(</span><span style="color:#66ccff;">SECRET_KEY</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">as_bytes</span><span style="color:#cccccc;">()).</span><span style="color:#8aa6c1;">unwrap</span><span style="color:#cccccc;">();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> claims </span><span>=</span><span style="color:#cccccc;"> RegisteredClaims {
</span><span style="color:#cccccc;">        subject: </span><span style="color:#8aa6c1;">Some</span><span style="color:#cccccc;">(</span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">to_string</span><span style="color:#cccccc;">()),
</span><span style="color:#cccccc;">        </span><span>..</span><span style="color:#cccccc;">RegisteredClaims::default()
</span><span style="color:#cccccc;">    };
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> header </span><span>= </span><span style="color:#cccccc;">Header::default();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">let</span><span style="color:#cccccc;"> token </span><span>= </span><span style="color:#cccccc;">Token::new(header, claims)
</span><span style="color:#cccccc;">        .</span><span style="color:#8aa6c1;">sign_with_key</span><span style="color:#cccccc;">(</span><span>&amp;</span><span style="color:#cccccc;">secret_key)
</span><span style="color:#cccccc;">        .</span><span style="color:#8aa6c1;">unwrap</span><span style="color:#cccccc;">();
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    println!(</span><span style="color:#ffd700;">&quot;</span><span style="color:#66ccff;">{}</span><span style="color:#ffd700;">&quot;</span><span style="color:#cccccc;">, token.</span><span style="color:#8aa6c1;">as_str</span><span style="color:#cccccc;">());
</span><span style="color:#cccccc;">
</span><span style="color:#cccccc;">    </span><span style="color:#80d500;">match </span><span style="color:#cccccc;">VerifyWithKey::&lt;Token&lt;Header, BTreeMap&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">, </span><span style="color:#8aa6c1;">Option</span><span style="color:#cccccc;">&lt;</span><span style="color:#8aa6c1;">String</span><span style="color:#cccccc;">&gt;&gt;, </span><span>_</span><span style="color:#cccccc;">&gt;&gt;::verify_with_key(
</span><span style="color:#cccccc;">        token.</span><span style="color:#8aa6c1;">as_str</span><span style="color:#cccccc;">(),
</span><span style="color:#cccccc;">        </span><span>&amp;</span><span style="color:#cccccc;">secret_key,
</span><span style="color:#cccccc;">    ) {
</span><span style="color:#cccccc;">        </span><span style="color:#8aa6c1;">Ok</span><span style="color:#cccccc;">(token) </span><span>=&gt; </span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">            assert_eq!(</span><span style="color:#8aa6c1;">Some</span><span style="color:#cccccc;">(</span><span style="color:#66ccff;">DATA</span><span style="color:#cccccc;">.</span><span style="color:#8aa6c1;">to_string</span><span style="color:#cccccc;">()), token.</span><span style="color:#8aa6c1;">claims</span><span style="color:#cccccc;">()[</span><span style="color:#ffd700;">&quot;sub&quot;</span><span style="color:#cccccc;">]);
</span><span style="color:#cccccc;">        }
</span><span style="color:#cccccc;">        </span><span style="color:#8aa6c1;">Err</span><span style="color:#cccccc;">(e) </span><span>=&gt; </span><span style="color:#cccccc;">{
</span><span style="color:#cccccc;">            panic!(</span><span style="color:#ffd700;">&quot;Token is not valid: {}&quot;</span><span style="color:#cccccc;">, e)
</span><span style="color:#cccccc;">        }
</span><span style="color:#cccccc;">    }
</span><span style="color:#cccccc;">}
</span></code></pre>
</details>
<p>I pushed the changes in the rust-jwt library to my fork in case anyone hits this incredibly specific issue: <a href="https://github.com/orhun/rust-jwt"><strong>https://github.com/orhun/rust-jwt</strong></a> </p>
<p>Thanks for coming down with me to this rabbit hole! üêá</p>
<p>(Special thanks to <a href="https://timhei.de">Tim Heide</a> for bringing this issue to my attention.)</p>
<p>~ cya!</p>

    </div>

    
        <footer>
            <hr>
            <p>
                
                    Published by Orhun Parmaksƒ±z
                
                
                    
                    in <a href="https://blog.orhun.dev/categories/guides/">Guides</a>
                
                
            </p>
            
            
            <iframe src="https://github.com/sponsors/orhun/button" title="Sponsor @orhun" height="35" width="116" style="border: 0;"></iframe>
            <script src="https://utteranc.es/client.js"
                    repo="orhun/personal-blog"
                    issue-term="url"
                    label="comments"
                    theme="github-dark"
                    crossorigin="anonymous"
                    async>
            </script>
        </footer>
    
</article>


    </body>

</html>
